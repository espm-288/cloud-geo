{
  "hash": "73ec8608d7eb19954853e754021ef32f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"1: Satellite data\"\nauthor: Carl Boettiger\ndate: \"2024-01-31\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rstac)\nlibrary(gdalcubes)\nlibrary(stars)\nlibrary(tmap)\nlibrary(dplyr)\nearthdatalogin::gdal_cloud_config()\ngdalcubes::gdalcubes_options(parallel = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbox <- c(xmin=-123, ymin=37, xmax=-121, ymax=39) \nstart_date <- \"2022-06-01\"\nend_date <- \"2022-08-01\"\nitems <-\n  stac(\"https://earth-search.aws.element84.com/v0/\") |>\n  stac_search(collections = \"sentinel-s2-l2a-cogs\",\n              bbox = box,\n              datetime = paste(start_date, end_date, sep=\"/\"),\n              limit = 100) |>\n  ext_query(\"eo:cloud_cover\" < 20) |>\n  post_request()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol <- stac_image_collection(items$features, asset_names = c(\"B08\", \"B04\", \"SCL\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in stac_image_collection(items$features, asset_names = c(\"B08\", : STAC\nasset with name 'SCL' does not include eo:bands metadata and will be considered\nas a single band source\n```\n\n\n:::\n\n```{.r .cell-code}\ncube <- cube_view(srs =\"EPSG:4326\",\n                  extent = list(t0 = start_date, t1 = end_date,\n                                left = box[1], right = box[3],\n                                top = box[4], bottom = box[2]),\n                  dx = 0.001, dy = 0.001, dt = \"P1M\",\n                  aggregation = \"median\", resampling = \"average\")\n```\n:::\n\n\n\nThe  SCL data layer in Sentinel is one of three 'quality assurance' layers provided in this data catalog. Table 3 in this description of the [Sentinel-2 Level2A Specifications](https://docs.digitalearthafrica.org/en/latest/data_specs/Sentinel-2_Level-2A_specs.html) summarizes the classification codes (Cloud shadows, medium probability cloud, high probability cloud).  An image mask basically drops these bad pixels.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmask <- image_mask(\"SCL\", values=c(3, 8, 9)) # mask clouds and cloud shadows\n\ndata <-  raster_cube(col, cube, mask = mask)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nndvi <- data |>\n  select_bands(c(\"B04\", \"B08\")) |>\n  apply_pixel(\"(B08-B04)/(B08+B04)\", \"NDVI\") |>\n  reduce_time(c(\"mean(NDVI)\")) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nndvi_stars <- st_as_stars(ndvi)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmako <- tm_scale_continuous(values = viridisLite::mako(30))\nfill <- tm_scale_continuous(values = \"Greens\")\n\ntm_shape(ndvi_stars) + tm_raster(col.scale = mako)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nstars object downsampled to 1000 by 1000 cells.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in value[[3L]](cond): could not rename the data.table\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](example-1_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::",
    "supporting": [
      "example-1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}